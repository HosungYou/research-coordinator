checkpoints:
  # Research Direction and Planning
  - id: CP_RESEARCH_DIRECTION
    name: "Research Direction Validated"
    level: RED
    description: "Research question, objectives, and scope are clearly defined and feasible"
    trigger:
      - "Research question formulated"
      - "PICO/PEO framework defined"
      - "Scope and boundaries clarified"
    validation:
      required_fields:
        - research_question
        - objectives
        - scope_constraints
      rules:
        - field: research_question
          min_length: 20
          must_contain: ["?"]
        - field: objectives
          type: list
          min_items: 1
    auto_actions:
      - "Generate protocol.md from template"
      - "Initialize project structure"
    next_checkpoint: CP_DATABASE_SELECTION
    typical_duration: "15-30 minutes"

  - id: CP_DATABASE_SELECTION
    name: "Database Selection Complete"
    level: RED
    description: "Information sources and search strategy finalized"
    trigger:
      - "Databases selected with justification"
      - "Search terms and Boolean logic defined"
      - "Gray literature sources identified"
    validation:
      required_fields:
        - databases
        - search_terms
        - boolean_search
      rules:
        - field: databases
          type: list
          min_items: 2
        - field: boolean_search
          must_contain: ["AND", "OR"]
    auto_actions:
      - "Generate search-strategy.md"
      - "Validate database API access"
      - "Create search log template"
    next_checkpoint: CP_SCREENING_CRITERIA
    typical_duration: "20-40 minutes"

  - id: CP_SCREENING_CRITERIA
    name: "Screening Criteria Defined"
    level: RED
    description: "Inclusion/exclusion criteria established with decision rules"
    trigger:
      - "Inclusion criteria finalized"
      - "Exclusion criteria finalized"
      - "Edge case decision rules documented"
    validation:
      required_fields:
        - inclusion_criteria
        - exclusion_criteria
      rules:
        - field: inclusion_criteria
          type: object
          required_keys: ["population", "intervention", "outcomes", "study_design"]
        - field: exclusion_criteria
          type: list
          min_items: 3
    auto_actions:
      - "Generate inclusion-criteria.md"
      - "Create screening pilot template"
      - "Initialize inter-rater reliability tracking"
    next_checkpoint: CP_SCREENING_COMPLETE
    typical_duration: "30-60 minutes"

  # Screening and Selection
  - id: CP_SCREENING_COMPLETE
    name: "Screening Complete"
    level: YELLOW
    description: "All papers screened against inclusion/exclusion criteria"
    trigger:
      - "Title/abstract screening finished"
      - "Full-text review completed"
      - "Exclusion reasons documented"
    validation:
      required_fields:
        - screening_results
        - inter_rater_reliability
      rules:
        - field: screening_results
          must_have_columns: ["study_id", "included", "exclusion_reason"]
        - field: inter_rater_reliability
          metric: "Cohen's Kappa"
          min_value: 0.70
    auto_actions:
      - "Generate screening-results.csv"
      - "Update PRISMA flow diagram counts"
      - "Flag low inter-rater agreement items"
    next_checkpoint: CP_QUALITY_APPRAISAL
    typical_duration: "Variable (depends on paper count)"

  - id: CP_QUALITY_APPRAISAL
    name: "Quality Assessment Complete"
    level: YELLOW
    description: "Risk of bias assessment conducted for all included studies"
    trigger:
      - "Quality assessment tool selected"
      - "All studies assessed"
      - "Quality summary generated"
    validation:
      required_fields:
        - quality_tool
        - assessed_studies
      rules:
        - field: assessed_studies
          must_have_columns: ["study_id", "overall_risk"]
        - field: quality_summary
          must_have_keys: ["low_risk_count", "moderate_risk_count", "high_risk_count"]
    auto_actions:
      - "Generate quality-assessment.md"
      - "Flag high-risk studies for sensitivity analysis"
      - "Create quality summary table"
    next_checkpoint: CP_EXTRACTION_COMPLETE
    typical_duration: "Variable (depends on study count)"

  # Data Extraction (Meta-Analysis Specific)
  - id: CP_EXTRACTION_COMPLETE
    name: "Data Extraction Complete"
    level: YELLOW
    description: "All effect sizes and moderators extracted and validated"
    trigger:
      - "Effect size data extracted from all studies"
      - "Moderator variables coded"
      - "Extraction accuracy verified"
    validation:
      required_fields:
        - extracted_effects
        - moderator_coding
      rules:
        - field: extracted_effects
          must_have_columns: ["study_id", "effect_size", "variance", "n"]
        - field: moderator_coding
          completeness: 1.0
    auto_actions:
      - "Generate extracted-effects.csv"
      - "Calculate effect size descriptive statistics"
      - "Flag outliers (|z| > 3.29)"
    next_checkpoint: CP_ANALYSIS_COMPLETE
    typical_duration: "Variable (depends on study count)"

  # Synthesis and Analysis
  - id: CP_SYNTHESIS_APPROACH
    name: "Synthesis Approach Decided"
    level: YELLOW
    description: "Synthesis method selected and justified"
    trigger:
      - "Synthesis method chosen (narrative vs. meta-analysis)"
      - "Synthesis plan documented"
      - "Analysis software selected"
    validation:
      required_fields:
        - synthesis_method
        - synthesis_justification
      rules:
        - field: synthesis_method
          allowed_values: ["narrative", "meta-analysis", "mixed"]
        - field: synthesis_justification
          min_length: 100
    auto_actions:
      - "Generate synthesis-plan.md"
      - "Create analysis script template (if meta-analysis)"
      - "Prepare data files for analysis"
    next_checkpoint: CP_ANALYSIS_COMPLETE
    typical_duration: "30-60 minutes"

  - id: CP_META_APPROACH
    name: "Meta-Analytic Approach Defined"
    level: RED
    description: "Effect size metric, pooling model, and heterogeneity plan specified"
    trigger:
      - "Effect size metric selected"
      - "Pooling model decided (fixed vs. random)"
      - "Heterogeneity assessment plan defined"
    validation:
      required_fields:
        - effect_size_metric
        - pooling_model
        - heterogeneity_tests
      rules:
        - field: effect_size_metric
          allowed_values: ["d", "g", "r", "OR", "RR", "SMD"]
        - field: pooling_model
          allowed_values: ["fixed", "random", "mixed"]
        - field: heterogeneity_tests
          type: list
          must_contain: ["I²"]
    auto_actions:
      - "Generate effect-size-plan.md"
      - "Prepare conversion formulas"
      - "Create analysis plan template"
    next_checkpoint: CP_EXTRACTION_COMPLETE
    typical_duration: "20-40 minutes"

  - id: CP_ANALYSIS_COMPLETE
    name: "Statistical Analysis Complete"
    level: YELLOW
    description: "Meta-analysis conducted, heterogeneity assessed, moderators tested"
    trigger:
      - "Pooled effect size calculated"
      - "Heterogeneity statistics computed"
      - "Moderator analyses completed"
    validation:
      required_fields:
        - pooled_effects
        - heterogeneity_results
      rules:
        - field: pooled_effects
          must_have_keys: ["estimate", "ci_lower", "ci_upper", "p_value"]
        - field: heterogeneity_results
          must_have_keys: ["Q", "I²", "tau²"]
    auto_actions:
      - "Generate pooled-effects.md"
      - "Generate forest plots"
      - "Generate heterogeneity-results.md"
    next_checkpoint: CP_HETEROGENEITY_CHECKED
    typical_duration: "Variable (depends on analysis complexity)"

  - id: CP_HETEROGENEITY_CHECKED
    name: "Heterogeneity Investigated"
    level: BLUE
    description: "Sources of heterogeneity explored and explained"
    trigger:
      - "Heterogeneity statistics interpreted"
      - "Moderator analyses explain variance"
      - "Sensitivity analyses conducted"
    validation:
      required_fields:
        - moderator_results
        - sensitivity_results
      rules:
        - field: moderator_results
          must_have_keys: ["Q_between", "R²"]
    auto_actions:
      - "Generate moderator-results.md"
      - "Update synthesis narrative"
      - "Flag unexplained heterogeneity for discussion"
    next_checkpoint: CP_PUBLICATION_BIAS_CHECKED
    typical_duration: "Variable"

  - id: CP_PUBLICATION_BIAS_CHECKED
    name: "Publication Bias Assessed"
    level: BLUE
    description: "Publication bias evaluated and addressed"
    trigger:
      - "Funnel plot generated"
      - "Egger's test conducted"
      - "Trim-and-fill analysis performed"
    validation:
      required_fields:
        - publication_bias_tests
      rules:
        - field: publication_bias_tests
          must_have_keys: ["funnel_plot", "eggers_test"]
    auto_actions:
      - "Generate publication-bias-report.md"
      - "Flag asymmetry if detected"
      - "Report adjusted estimates"
    next_checkpoint: CP_FINAL_REVIEW
    typical_duration: "20-30 minutes"

  # Reporting and Finalization
  - id: CP_FINAL_REVIEW
    name: "Final Review Complete"
    level: BLUE
    description: "All analyses reviewed, PRISMA checklist completed"
    trigger:
      - "PRISMA 2020 checklist completed"
      - "All figures and tables finalized"
      - "Manuscript draft ready"
    validation:
      required_fields:
        - prisma_checklist
        - manuscript_draft
      rules:
        - field: prisma_checklist
          completeness: 1.0
        - field: manuscript_draft
          sections: ["abstract", "introduction", "methods", "results", "discussion"]
    auto_actions:
      - "Generate PRISMA flow diagram"
      - "Generate manuscript.md from template"
      - "Create supplementary materials folder"
    next_checkpoint: CP_PUBLICATION_READY
    typical_duration: "Variable (depends on manuscript length)"

  - id: CP_PUBLICATION_READY
    name: "Publication Ready"
    level: BLUE
    description: "Manuscript, figures, and supplementary materials ready for submission"
    trigger:
      - "Manuscript finalized"
      - "All figures publication-quality"
      - "Supplementary materials complete"
    validation:
      required_fields:
        - manuscript_final
        - figures
        - supplementary_materials
      rules:
        - field: figures
          format: ["PNG", "PDF", "TIFF"]
          min_dpi: 300
        - field: supplementary_materials
          must_include: ["PRISMA_checklist.pdf", "search_strategies.pdf"]
    auto_actions:
      - "Generate submission package"
      - "Create README for supplementary materials"
      - "Archive analysis code and data"
    next_checkpoint: null
    typical_duration: "Variable"

  # Systematic Review Automation Checkpoints
  - id: SCH_DATABASE_SELECTION
    name: "Database Selection"
    level: RED
    description: "API-accessible databases selected (Semantic Scholar, OpenAlex, arXiv)"
    trigger:
      - "User specifies databases for automated retrieval"
    validation:
      required_fields:
        - databases
      rules:
        - field: databases
          type: list
          allowed_values: ["semantic_scholar", "openalex", "arxiv"]
          min_items: 1
    auto_actions:
      - "Validate API keys in environment"
      - "Test API connectivity"
      - "Warn if no open-access databases selected"
    next_checkpoint: SCH_SCREENING_CRITERIA
    agent: I1-paper-retrieval-agent

  - id: SCH_SCREENING_CRITERIA
    name: "Screening Criteria Loaded"
    level: RED
    description: "Inclusion/exclusion criteria configured for LLM screening"
    trigger:
      - "Inclusion/exclusion criteria finalized"
    validation:
      required_fields:
        - inclusion_criteria
        - llm_provider
        - llm_model
      rules:
        - field: llm_provider
          allowed_values: ["groq", "anthropic", "ollama"]
        - field: llm_model
          must_exist: true
    auto_actions:
      - "Load LLM model"
      - "Validate API key for selected provider"
      - "Create screening prompt template"
    next_checkpoint: SCH_RAG_READINESS
    agent: I2-screening-assistant

  - id: SCH_RAG_READINESS
    name: "RAG System Ready"
    level: YELLOW
    description: "PDFs downloaded and ready for vector database construction"
    trigger:
      - "PDF download stage complete"
      - "Minimum paper count threshold met"
    validation:
      required_fields:
        - pdf_count
        - success_rate
      rules:
        - field: pdf_count
          min_value: 5
        - field: success_rate
          min_value: 0.3
    auto_actions:
      - "Validate PDF file integrity"
      - "Prepare embedding model"
      - "Initialize ChromaDB collection"
    next_checkpoint: SCH_QUALITY_GATES
    agent: I3-rag-builder

  - id: SCH_QUALITY_GATES
    name: "PRISMA Quality Validation"
    level: BLUE
    description: "PRISMA 2020 compliance validated across pipeline"
    trigger:
      - "RAG queries ready"
      - "User requests quality audit"
    validation:
      required_fields:
        - screening_logs
        - deduplication_logs
        - prisma_counts
      rules:
        - field: prisma_counts
          must_have_keys: ["identified", "screened", "included"]
    auto_actions:
      - "Generate PRISMA flow diagram"
      - "Validate screening decision logs"
      - "Check inter-rater reliability (if applicable)"
    next_checkpoint: CP_FINAL_REVIEW
    agent: I4-quality-auditor

# Checkpoint Level Definitions
checkpoint_levels:
  RED:
    priority: CRITICAL
    description: "Must complete before proceeding to next stage"
    blocking: true
    color: "#FF0000"

  YELLOW:
    priority: HIGH
    description: "Important validation, but may proceed with caution"
    blocking: false
    color: "#FFD700"

  BLUE:
    priority: MEDIUM
    description: "Quality assurance checkpoint"
    blocking: false
    color: "#1E90FF"

# Checkpoint State Transitions
state_transitions:
  - from: null
    to: RED
    condition: "Research direction checkpoint reached"

  - from: RED
    to: YELLOW
    condition: "All RED checkpoints passed in current stage"

  - from: YELLOW
    to: BLUE
    condition: "Primary analysis complete"

  - from: BLUE
    to: null
    condition: "Final review complete"

# Validation Rule Types
validation_rule_types:
  required_fields:
    description: "Fields that must exist in checkpoint data"
    example: ["research_question", "objectives"]

  rules:
    description: "Field-level validation rules"
    types:
      - type: min_length
        description: "Minimum string length"
      - type: min_value
        description: "Minimum numeric value"
      - type: min_items
        description: "Minimum list/array length"
      - type: allowed_values
        description: "Whitelist of allowed values"
      - type: must_contain
        description: "Required substring or list item"
      - type: must_have_keys
        description: "Required keys in dictionary/object"
      - type: must_have_columns
        description: "Required columns in CSV/DataFrame"
      - type: completeness
        description: "Fraction of non-null values (0.0-1.0)"
