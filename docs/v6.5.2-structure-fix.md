# Diverga v6.5.2 Release Notes

## Structure Fix for Task Tool Agent Recognition

**Release Date**: 2026-01-27
**Type**: Breaking Change / Bugfix

---

## Summary

v6.5.2 fixes a critical issue where `/agents/` directory was not recognized by Claude Code's Task tool, preventing parallel agent execution via `Task(subagent_type="diverga:a1", ...)`.

---

## Problem

### Symptom

```
Task(subagent_type="diverga:a1", prompt="...")

Error: Agent type 'diverga:a1' not found.
Available agents: Bash, general-purpose, oh-my-claudecode:architect, ...
```

Notice: `diverga:*` agents were completely absent from the available agents list.

### Root Cause

The `marketplace.json` had an explicit `skills` array:

```json
{
  "plugins": [{
    "name": "diverga",
    "source": "./",
    "skills": [
      "./.claude/skills/research-coordinator",
      "./.claude/skills/research-agents/A1-research-question-refiner",
      // ... 40+ skill paths
    ]
  }]
}
```

**When `skills` key is explicitly defined:**
- Claude Code ONLY loads the specified skill paths
- `/agents/` directory is NOT auto-scanned
- Task tool cannot find any `diverga:*` agents

**Comparison with oh-my-claudecode (works correctly):**

```json
{
  "plugins": [{
    "name": "oh-my-claudecode",
    "source": "./"
    // NO skills key → Claude Code auto-scans /agents/ + /skills/
  }]
}
```

---

## Solution

### Directory Structure Change

```
BEFORE (v6.5.1):                    AFTER (v6.5.2):
├── .claude/                        ├── .claude/
│   └── skills/        ❌ Used      │   └── skills/      (deprecated)
├── agents/            ⚠️ Ignored   ├── agents/          ✅ Auto-scanned
└── marketplace.json                ├── skills/          ✅ NEW (root level)
    └── skills: [...]  ❌ Problem   └── marketplace.json
                                        └── (no skills key) ✅ Fixed
```

### marketplace.json Simplification

**Before (v6.5.1):**
```json
{
  "plugins": [{
    "name": "diverga",
    "source": "./",
    "strict": false,
    "skills": [
      "./.claude/skills/research-coordinator",
      "./.claude/skills/research-agents/A1-research-question-refiner",
      // ... 40+ paths
    ]
  }]
}
```

**After (v6.5.2):**
```json
{
  "plugins": [{
    "name": "diverga",
    "source": "./"
  }]
}
```

---

## Migration Guide

### For Users

```bash
# 1. Uninstall existing plugin
/plugin uninstall diverga

# 2. Reinstall (fetches v6.5.2)
/plugin install diverga

# 3. IMPORTANT: Restart Claude Code
# Exit current session and start new one

# 4. Verify agents are available
Task(subagent_type="diverga:a1", prompt="Test research question refinement")
```

### For Developers

If you're developing Claude Code plugins with both `/agents/` and `/skills/`:

**DO:**
```json
{
  "plugins": [{
    "name": "my-plugin",
    "source": "./"
    // Let Claude Code auto-discover directories
  }]
}
```

**DON'T:**
```json
{
  "plugins": [{
    "name": "my-plugin",
    "source": "./",
    "skills": ["./skills/..."]  // This prevents /agents/ auto-scan!
  }]
}
```

---

## Files Changed

| File | Change |
|------|--------|
| `.claude-plugin/marketplace.json` | Removed `skills` array, simplified structure |
| `skills/` | NEW: 95 skill files moved from `.claude/skills/` |
| `.claude/skills/` | Deprecated (kept for backwards compatibility) |
| `CHANGELOG.md` | Added v6.5.2 documentation |
| `README.md` | Updated version badge to 6.5.2 |

---

## Verification Checklist

After reinstall, verify these work:

### Task Tool (Agent Invocation)

```python
# Should work - agents auto-discovered
Task(subagent_type="diverga:a1", prompt="Refine: AI in education")
Task(subagent_type="diverga:a6", prompt="Visualize conceptual framework")
Task(subagent_type="diverga:c5", prompt="Meta-analysis workflow")
```

### Skill Tool (Slash Commands)

```bash
# Should work - skills auto-discovered
/diverga:research-coordinator
/diverga:setup
/diverga:help
```

### Parallel Execution

```python
# Multiple agents in parallel - the main v6.5 feature
Task(subagent_type="diverga:a1", prompt="...", run_in_background=True)
Task(subagent_type="diverga:b1", prompt="...", run_in_background=True)
Task(subagent_type="diverga:c1", prompt="...", run_in_background=True)
```

---

## Technical Details

### Claude Code Plugin Discovery Mechanism

1. **If `skills` key is absent:**
   - Auto-scan `/agents/*.md` → Register as `plugin:agent-name`
   - Auto-scan `/skills/*/SKILL.md` → Register as `plugin:skill-name`

2. **If `skills` key is present:**
   - ONLY load explicitly listed skill paths
   - Do NOT scan `/agents/` directory
   - Task tool cannot find any agents from this plugin

### Why oh-my-claudecode Works

oh-my-claudecode has `/agents/` directory with 28 agent definitions and no explicit `skills` key in marketplace.json. Claude Code auto-discovers both directories.

---

## Related Issues

- v6.5.0: Added `/agents/` directory for parallel execution
- v6.5.1: Removed invalid `runtime` key from marketplace.json
- v6.5.2: Fixed directory structure for proper agent discovery

---

## Support

If agents still don't appear after reinstall:

1. **Restart Claude Code completely** (not just new conversation)
2. Check plugin cache: `ls ~/.claude/plugins/cache/diverga/`
3. Verify commit SHA matches v6.5.2: `37ea4fe` or later
4. Report issues: https://github.com/HosungYou/Diverga/issues

---

*Diverga v6.5.2 - Structure Fix for Task Tool Agent Recognition*
