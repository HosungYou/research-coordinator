# Diverga v6.5.0: Task Tool 등록 실패 - 근본 원인 분석

**날짜**: 2026-01-27
**상태**: 근본 원인 확인됨, 해결책 필요

---

## 문제 요약

`Task(subagent_type="diverga:a1")`이 작동하지 않음.

**에러 메시지**:
```
Agent type 'diverga:a1' not found. Available agents: Bash, general-purpose,
..., oh-my-claudecode:code-reviewer, oh-my-claudecode:scientist, ...
```

---

## 근본 원인

### 1. Claude Code의 에이전트 등록 메커니즘

oh-my-claudecode 에이전트들이 Task tool에서 작동하는 이유를 분석한 결과:

**에이전트 등록은 `getAgentDefinitions()`가 아니라 글로벌 CLAUDE.md에서 발생**

Claude Code의 Task tool 설명에서 확인:
```
Available agent types and the tools they have access to:
- oh-my-claudecode:code-reviewer: Expert code review specialist...
- oh-my-claudecode:scientist: Data analysis and research execution specialist...
```

이 목록은 **시스템 프롬프트에 하드코딩**되어 있음.

### 2. TypeScript Runtime의 역할

우리가 만든 TypeScript runtime (`src/agents/definitions.ts`):
- `getAgentDefinitions()` 함수 제공
- `@anthropic-ai/claude-agent-sdk`를 통한 **프로그래매틱 사용** 가능
- Claude Code의 Task tool과 **직접 통합되지 않음**

### 3. 차이점 비교

| 측면 | oh-my-claudecode | Diverga |
|------|------------------|---------|
| 에이전트 정의 | `src/agents/definitions.ts` | `src/agents/definitions.ts` ✅ |
| 글로벌 CLAUDE.md 등록 | ✅ 포함됨 | ❌ 누락 |
| Task tool 인식 | ✅ 작동 | ❌ 실패 |
| Skill tool 인식 | ✅ 작동 | ✅ 작동 |

---

## 해결책

### 옵션 1: 글로벌 CLAUDE.md에 Diverga 에이전트 등록 (권장)

`/Users/hosung/.claude/CLAUDE.md`의 Task tool 설명에 Diverga 에이전트 추가:

```markdown
When using the Task tool, you must specify a subagent_type parameter...

Available agent types and the tools they have access to:
...
- diverga:a1: VS-Enhanced Research Question Refiner (Opus) (Tools: Read, Glob, Grep, WebSearch)
- diverga:a2: VS-Enhanced Theoretical Framework Architect (Opus) (Tools: Read, Glob, Grep, WebSearch)
...
```

**장점**: 즉시 작동
**단점**: 글로벌 CLAUDE.md 수정 필요, 수동 유지보수

### 옵션 2: oh-my-claudecode에 Diverga 에이전트 래퍼 등록

oh-my-claudecode의 `definitions.ts`에 Diverga 에이전트를 래퍼로 추가:

```typescript
export const divergaA1Agent: AgentConfig = {
  name: 'diverga-a1',
  description: 'VS-Enhanced Research Question Refiner',
  prompt: loadSkillPrompt('diverga:A1-research-question-refiner'),
  tools: ['Read', 'Glob', 'Grep', 'WebSearch'],
  model: 'opus'
};
```

**장점**: oh-my-claudecode 인프라 활용
**단점**: oh-my-claudecode 의존성, 유지보수 복잡

### 옵션 3: Claude Code 플랫폼 변경 요청

Anthropic에 플러그인 시스템 개선 요청:
- `marketplace.json`의 `runtime.agents` 경로에서 에이전트 자동 등록
- 플러그인이 자체 `subagent_type` 정의 가능

**장점**: 깔끔한 아키텍처
**단점**: Anthropic 개발 필요, 시간 불확실

---

## 권장 조치

### 즉시 (옵션 1 적용)

1. 글로벌 CLAUDE.md에 Diverga 에이전트 40개 등록
2. 형식: `diverga:<shortId>: <description> (<model>) (Tools: ...)`
3. 테스트: `Task(subagent_type="diverga:a1")` 확인

### 장기

1. Claude Code 플랫폼 피처 요청 제출
2. 플러그인 기반 에이전트 등록 표준화 제안

---

## 현재 작동 상태

| 호출 방식 | 상태 | 사용법 |
|----------|------|--------|
| **Skill tool** | ✅ 작동 | `/diverga:A1-research-question-refiner` |
| **Task tool** | ❌ 실패 | `Task(subagent_type="diverga:a1")` |

---

## 기술 세부사항

### oh-my-claudecode 에이전트 등록 경로

```
글로벌 CLAUDE.md
    └── Task tool 설명
        └── "Available agent types:"
            └── oh-my-claudecode:architect
            └── oh-my-claudecode:explore
            └── ...
```

### Claude Code의 Task tool 처리

1. Task tool 호출 시 `subagent_type` 파라미터 확인
2. 시스템 프롬프트의 "Available agent types" 목록에서 검색
3. 목록에 없으면 에러 반환

### Diverga runtime의 현재 용도

```typescript
// 프로그래매틱 사용 가능 (Claude Agent SDK)
import { getAgentDefinitions, getAgent } from 'diverga';

const agents = getAgentDefinitions();
const a1 = getAgent('a1');

// Claude Code Task tool에서는 작동하지 않음
// Task(subagent_type="diverga:a1") → 에러
```

---

## 결론

Diverga v6.5.0의 TypeScript runtime은 **정확하게 구현**되었으나, Claude Code의 Task tool이 **플러그인 에이전트를 자동으로 발견하지 않음**.

oh-my-claudecode와 동일한 방식으로 작동하려면 **글로벌 CLAUDE.md에 에이전트를 명시적으로 등록**해야 함.
