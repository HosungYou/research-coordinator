name: Cross-Platform Plugin Tests

on:
  push:
    branches: [main]
    paths:
      - '.codex/**'
      - '.opencode/**'
      - 'scripts/**'
      - '.github/workflows/test-plugins.yml'
  pull_request:
    branches: [main]
    paths:
      - '.codex/**'
      - '.opencode/**'
      - 'scripts/**'

jobs:
  test-codex:
    name: Test Codex CLI Plugin
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Display Node.js version
        run: node --version

      - name: Test Codex CLI - Help
        run: node .codex/diverga-codex.cjs help

      - name: Test Codex CLI - Setup
        run: node .codex/diverga-codex.cjs setup

      - name: Test Codex CLI - List Agents
        run: node .codex/diverga-codex.cjs list

      - name: Test Codex CLI - Agent Details
        run: node .codex/diverga-codex.cjs agent A1

      - name: Test Codex CLI - T-Score
        run: node .codex/diverga-codex.cjs tscore

      - name: Test Codex CLI - Checkpoints
        run: node .codex/diverga-codex.cjs checkpoint

  test-opencode:
    name: Test OpenCode Plugin
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20, 22]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        working-directory: .opencode/plugins/diverga
        run: npm install

      - name: TypeScript type check
        working-directory: .opencode/plugins/diverga
        run: npm run typecheck

      - name: Build TypeScript
        working-directory: .opencode/plugins/diverga
        run: npm run build

      - name: Verify build output
        run: |
          ls -la .opencode/plugins/diverga/dist/
          test -f .opencode/plugins/diverga/dist/index.js
          test -f .opencode/plugins/diverga/dist/agents.js

  test-install-scripts:
    name: Test Install Scripts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Test install.sh syntax
        run: bash -n scripts/install.sh

      - name: Test install-codex.sh syntax
        run: bash -n scripts/install-codex.sh

      - name: Test install-opencode.sh syntax
        run: bash -n scripts/install-opencode.sh

  lint-docs:
    name: Verify Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required docs exist
        run: |
          test -f docs/QUICKSTART.md
          test -f docs/TROUBLESHOOTING.md
          test -f README.md
          test -f CLAUDE.md
          test -f AGENTS.md

