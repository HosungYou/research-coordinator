#!/usr/bin/env bash
# =============================================================================
# Research Coordinator CLI (rc)
# =============================================================================
# Cross-platform CLI tool for managing Research Coordinator agents
#
# Usage:
#   rc help                    - Show this help message
#   rc status                  - Show installation status
#   rc list                    - List all available agents
#   rc validate [agent]        - Validate agent contracts
#   rc info <agent>            - Show agent details
#   rc doctor                  - Diagnose installation issues
#   rc update                  - Update to latest version
#   rc uninstall               - Remove Research Coordinator
#
# Author: Research Coordinator v3.1
# License: MIT
# =============================================================================

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Version
VERSION="3.1.0"

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(dirname "$SCRIPT_DIR")"
SKILLS_DIR="$HOME/.claude/skills"
AGENTS_DIR="$REPO_DIR/.claude/skills/research-agents"
COORDINATOR_DIR="$REPO_DIR/.claude/skills/research-coordinator"

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

print_header() {
    echo -e "${BLUE}"
    echo "╔═══════════════════════════════════════════════════════╗"
    echo "║         Research Coordinator CLI v${VERSION}              ║"
    echo "║         사회과학 연구 에이전트 시스템                  ║"
    echo "╚═══════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

print_info() {
    echo -e "${CYAN}ℹ${NC} $1"
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_help() {
    print_header
    echo "Usage: rc <command> [options]"
    echo ""
    echo "Commands:"
    echo "  help                    Show this help message"
    echo "  status                  Show installation status"
    echo "  list                    List all available agents"
    echo "  validate [agent]        Validate agent contracts"
    echo "  info <agent>            Show agent details"
    echo "  doctor                  Diagnose installation issues"
    echo "  update                  Update to latest version"
    echo "  uninstall               Remove Research Coordinator"
    echo ""
    echo "Examples:"
    echo "  rc list                 # List all 21 agents"
    echo "  rc info 02              # Show info for agent 02"
    echo "  rc validate             # Validate all agents"
    echo "  rc validate 05          # Validate agent 05"
    echo ""
    echo "Documentation: https://github.com/HosungYou/research-coordinator"
}

cmd_status() {
    print_header
    echo "Installation Status"
    echo "───────────────────────────────────────────────────────"

    # Check if installed
    if [ -L "$SKILLS_DIR/research-coordinator" ] || [ -d "$SKILLS_DIR/research-coordinator" ]; then
        print_success "Research Coordinator: Installed"

        # Check version
        if [ -f "$SKILLS_DIR/research-coordinator/SKILL.md" ]; then
            local version=$(grep -m1 'version:' "$SKILLS_DIR/research-coordinator/SKILL.md" | awk '{print $2}' | tr -d '"')
            echo "        Version: $version"
        fi
    else
        print_error "Research Coordinator: Not installed"
        echo "        Run: ./scripts/install.sh"
    fi

    # Check agents
    if [ -L "$SKILLS_DIR/research-agents" ] || [ -d "$SKILLS_DIR/research-agents" ]; then
        local agent_count=$(ls -d "$SKILLS_DIR/research-agents"/*/ 2>/dev/null | wc -l | tr -d ' ')
        print_success "Research Agents: ${agent_count} agents installed"
    else
        print_error "Research Agents: Not installed"
    fi

    # Check Claude Code
    if command -v claude &> /dev/null; then
        local claude_version=$(claude --version 2>/dev/null || echo "unknown")
        print_success "Claude Code CLI: Available ($claude_version)"
    else
        print_warning "Claude Code CLI: Not found in PATH"
    fi

    echo ""
}

cmd_list() {
    print_header
    echo "Available Agents (21)"
    echo "───────────────────────────────────────────────────────"
    echo ""

    if [ ! -d "$AGENTS_DIR" ]; then
        print_error "Agents directory not found: $AGENTS_DIR"
        return 1
    fi

    # Category A
    echo -e "${CYAN}Category A: Theory & Research Design${NC}"
    for dir in "$AGENTS_DIR"/0[1-4]-*/; do
        if [ -d "$dir" ]; then
            local name=$(basename "$dir")
            local level=$(grep -m1 'upgrade_level:' "$dir/SKILL.md" 2>/dev/null | awk '{print $2}')
            printf "  %-40s [%s]\n" "$name" "${level:-UNKNOWN}"
        fi
    done
    echo ""

    # Category B
    echo -e "${CYAN}Category B: Literature & Evidence${NC}"
    for dir in "$AGENTS_DIR"/0[5-8]-*/; do
        if [ -d "$dir" ]; then
            local name=$(basename "$dir")
            local level=$(grep -m1 'upgrade_level:' "$dir/SKILL.md" 2>/dev/null | awk '{print $2}')
            printf "  %-40s [%s]\n" "$name" "${level:-UNKNOWN}"
        fi
    done
    echo ""

    # Category C
    echo -e "${CYAN}Category C: Methodology & Analysis${NC}"
    for dir in "$AGENTS_DIR"/{09,10,11,12}-*/; do
        if [ -d "$dir" ]; then
            local name=$(basename "$dir")
            local level=$(grep -m1 'upgrade_level:' "$dir/SKILL.md" 2>/dev/null | awk '{print $2}')
            printf "  %-40s [%s]\n" "$name" "${level:-UNKNOWN}"
        fi
    done
    echo ""

    # Category D
    echo -e "${CYAN}Category D: Quality & Validation${NC}"
    for dir in "$AGENTS_DIR"/1[3-6]-*/; do
        if [ -d "$dir" ]; then
            local name=$(basename "$dir")
            local level=$(grep -m1 'upgrade_level:' "$dir/SKILL.md" 2>/dev/null | awk '{print $2}')
            printf "  %-40s [%s]\n" "$name" "${level:-UNKNOWN}"
        fi
    done
    echo ""

    # Category E
    echo -e "${CYAN}Category E: Publication & Communication${NC}"
    for dir in "$AGENTS_DIR"/{17,18,19,20,21}-*/; do
        if [ -d "$dir" ]; then
            local name=$(basename "$dir")
            local level=$(grep -m1 'upgrade_level:' "$dir/SKILL.md" 2>/dev/null | awk '{print $2}')
            printf "  %-40s [%s]\n" "$name" "${level:-UNKNOWN}"
        fi
    done
    echo ""

    echo "───────────────────────────────────────────────────────"
    echo "Legend: [FULL] Full VS | [ENHANCED] Enhanced VS | [LIGHT] Light VS"
}

cmd_validate() {
    local agent_id="$1"

    print_header

    if [ -f "$SCRIPT_DIR/validate_agents.py" ]; then
        if [ -n "$agent_id" ]; then
            python3 "$SCRIPT_DIR/validate_agents.py" --agent "$agent_id" --verbose
        else
            python3 "$SCRIPT_DIR/validate_agents.py" --verbose
        fi
    else
        print_error "Validation script not found"
        echo "Expected: $SCRIPT_DIR/validate_agents.py"
        return 1
    fi
}

cmd_info() {
    local agent_id="$1"

    if [ -z "$agent_id" ]; then
        print_error "Usage: rc info <agent_id>"
        echo "Example: rc info 02"
        return 1
    fi

    print_header

    # Find agent directory
    local agent_dir=""
    for dir in "$AGENTS_DIR"/*-*/; do
        if [[ "$(basename "$dir")" == *"$agent_id"* ]]; then
            agent_dir="$dir"
            break
        fi
    done

    if [ -z "$agent_dir" ] || [ ! -d "$agent_dir" ]; then
        print_error "Agent not found: $agent_id"
        echo "Use 'rc list' to see available agents"
        return 1
    fi

    local skill_file="$agent_dir/SKILL.md"
    local name=$(basename "$agent_dir")

    echo "Agent Information: $name"
    echo "───────────────────────────────────────────────────────"

    if [ -f "$skill_file" ]; then
        # Extract frontmatter info
        local version=$(grep -m1 'version:' "$skill_file" | awk '{print $2}' | tr -d '"')
        local level=$(grep -m1 'upgrade_level:' "$skill_file" | awk '{print $2}')
        local dynamic_ts=$(grep -m1 'dynamic_t_score:' "$skill_file" | awk '{print $2}')

        echo ""
        echo -e "${CYAN}Basic Info${NC}"
        echo "  Name:           $name"
        echo "  Version:        ${version:-unknown}"
        echo "  Upgrade Level:  ${level:-unknown}"
        echo "  Dynamic T-Score: ${dynamic_ts:-unknown}"
        echo ""

        # Extract description (first paragraph after frontmatter)
        echo -e "${CYAN}Description${NC}"
        sed -n '/^---$/,/^---$/d; /^#/,/^$/p' "$skill_file" | head -5 | sed 's/^/  /'
        echo ""

        # Extract triggers if present
        if grep -q 'triggers:' "$skill_file"; then
            echo -e "${CYAN}Triggers${NC}"
            grep -A 10 'keywords:' "$skill_file" | head -8 | sed 's/^/  /'
        fi

        echo ""
        echo "───────────────────────────────────────────────────────"
        echo "Full documentation: $skill_file"
    else
        print_error "SKILL.md not found: $skill_file"
    fi
}

cmd_doctor() {
    print_header
    echo "Diagnosing Installation..."
    echo "───────────────────────────────────────────────────────"

    local issues=0

    # Check 1: Skills directory
    echo ""
    echo "Checking skills directory..."
    if [ -d "$SKILLS_DIR" ]; then
        print_success "Skills directory exists: $SKILLS_DIR"
    else
        print_error "Skills directory missing: $SKILLS_DIR"
        echo "  Fix: mkdir -p $SKILLS_DIR"
        ((issues++))
    fi

    # Check 2: Coordinator symlink
    echo ""
    echo "Checking coordinator installation..."
    if [ -L "$SKILLS_DIR/research-coordinator" ]; then
        local target=$(readlink "$SKILLS_DIR/research-coordinator")
        if [ -d "$target" ]; then
            print_success "Coordinator symlink valid: $target"
        else
            print_error "Coordinator symlink broken: $target"
            echo "  Fix: rm $SKILLS_DIR/research-coordinator && ./scripts/install.sh"
            ((issues++))
        fi
    elif [ -d "$SKILLS_DIR/research-coordinator" ]; then
        print_warning "Coordinator is a directory (not symlink)"
        echo "  This is fine, but symlinks are preferred for development"
    else
        print_error "Coordinator not installed"
        echo "  Fix: ./scripts/install.sh"
        ((issues++))
    fi

    # Check 3: Agents symlink
    echo ""
    echo "Checking agents installation..."
    if [ -L "$SKILLS_DIR/research-agents" ]; then
        local target=$(readlink "$SKILLS_DIR/research-agents")
        if [ -d "$target" ]; then
            print_success "Agents symlink valid: $target"
            local count=$(ls -d "$target"/*/ 2>/dev/null | wc -l | tr -d ' ')
            print_info "Found $count agent directories"
        else
            print_error "Agents symlink broken: $target"
            ((issues++))
        fi
    elif [ -d "$SKILLS_DIR/research-agents" ]; then
        print_warning "Agents is a directory (not symlink)"
    else
        print_error "Agents not installed"
        ((issues++))
    fi

    # Check 4: SKILL.md files
    echo ""
    echo "Checking SKILL.md files..."
    local missing_skills=0
    for dir in "$AGENTS_DIR"/*/; do
        if [ -d "$dir" ] && [ ! -f "$dir/SKILL.md" ]; then
            print_error "Missing SKILL.md: $dir"
            ((missing_skills++))
        fi
    done
    if [ $missing_skills -eq 0 ]; then
        print_success "All agents have SKILL.md files"
    fi

    # Check 5: Python (for validation)
    echo ""
    echo "Checking Python..."
    if command -v python3 &> /dev/null; then
        local py_version=$(python3 --version 2>&1)
        print_success "Python available: $py_version"
    else
        print_warning "Python 3 not found (optional, for validation)"
    fi

    # Summary
    echo ""
    echo "───────────────────────────────────────────────────────"
    if [ $issues -eq 0 ]; then
        print_success "No issues found! Installation is healthy."
    else
        print_error "Found $issues issue(s)"
        echo ""
        echo "Quick fix: Run './scripts/install.sh' to reinstall"
    fi
}

cmd_update() {
    print_header
    echo "Updating Research Coordinator..."
    echo "───────────────────────────────────────────────────────"

    cd "$REPO_DIR"

    # Check if git repo
    if [ ! -d ".git" ]; then
        print_error "Not a git repository"
        echo "Please update manually or reinstall from GitHub"
        return 1
    fi

    # Fetch updates
    echo "Fetching updates..."
    git fetch origin

    # Check for updates
    local local_hash=$(git rev-parse HEAD)
    local remote_hash=$(git rev-parse origin/main 2>/dev/null || git rev-parse origin/master)

    if [ "$local_hash" = "$remote_hash" ]; then
        print_success "Already up to date!"
    else
        echo "Updates available. Pulling changes..."
        git pull origin main 2>/dev/null || git pull origin master
        print_success "Updated successfully!"

        # Show changelog
        echo ""
        echo "Recent changes:"
        git log --oneline -5
    fi
}

cmd_uninstall() {
    print_header
    echo "Uninstalling Research Coordinator..."
    echo "───────────────────────────────────────────────────────"

    echo ""
    print_warning "This will remove:"
    echo "  - $SKILLS_DIR/research-coordinator"
    echo "  - $SKILLS_DIR/research-agents"
    echo ""

    read -p "Are you sure? (y/N) " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # Remove symlinks/directories
        if [ -L "$SKILLS_DIR/research-coordinator" ] || [ -d "$SKILLS_DIR/research-coordinator" ]; then
            rm -rf "$SKILLS_DIR/research-coordinator"
            print_success "Removed research-coordinator"
        fi

        if [ -L "$SKILLS_DIR/research-agents" ] || [ -d "$SKILLS_DIR/research-agents" ]; then
            rm -rf "$SKILLS_DIR/research-agents"
            print_success "Removed research-agents"
        fi

        echo ""
        print_success "Uninstallation complete!"
        echo ""
        echo "Note: The repository at $REPO_DIR was not removed."
        echo "To completely remove, run: rm -rf $REPO_DIR"
    else
        echo "Uninstallation cancelled."
    fi
}

# =============================================================================
# MAIN
# =============================================================================

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        help|--help|-h)
            cmd_help
            ;;
        status)
            cmd_status
            ;;
        list|ls)
            cmd_list
            ;;
        validate|check)
            cmd_validate "$@"
            ;;
        info|show)
            cmd_info "$@"
            ;;
        doctor|diagnose)
            cmd_doctor
            ;;
        update|upgrade)
            cmd_update
            ;;
        uninstall|remove)
            cmd_uninstall
            ;;
        version|--version|-v)
            echo "Research Coordinator CLI v$VERSION"
            ;;
        *)
            print_error "Unknown command: $command"
            echo "Run 'rc help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
